{% if site.comments.provider %}
<div id="comments-section" class="comments-section">
  <h3 id="comments-toggle" class="comments-toggle">Comments <span class="toggle-icon">â–¼</span></h3>
  <div id="comments-content-wrapper" class="comments-content-wrapper">
    <div id="comments-container"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const commentsContainer = document.getElementById('comments-container');
    const commentsSection = document.getElementById('comments-section');

    const loadComments = (entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          // Stop observing once it's loaded
          observer.unobserve(commentsSection);

          const script = document.createElement('script');
          script.async = true;

          {% if site.comments.provider == 'giscus' and site.comments.giscus.repo %}
            script.src = 'https://giscus.app/client.js';
            script.setAttribute('data-repo', '{{ site.comments.giscus.repo }}');
            script.setAttribute('data-repo-id', '{{ site.comments.giscus.repo_id }}');
            script.setAttribute('data-category', '{{ site.comments.giscus.category }}');
            script.setAttribute('data-category-id', '{{ site.comments.giscus.category_id }}');
            script.setAttribute('data-mapping', '{{ site.comments.giscus.mapping }}');
            script.setAttribute('data-reactions-enabled', '{{ site.comments.giscus.reactions_enabled }}');
            script.setAttribute('data-emit-metadata', '{{ site.comments.giscus.emit_metadata }}');
            script.setAttribute('data-theme', '{{ site.comments.giscus.theme }}');
            script.setAttribute('crossorigin', 'anonymous');
          {% elsif site.comments.provider == 'utterances' and site.comments.utterances.repo %}
            script.src = 'https://utteranc.es/client.js';
            script.setAttribute('repo', '{{ site.comments.utterances.repo }}');
            script.setAttribute('issue-term', '{{ site.comments.utterances.issue_term }}');
            script.setAttribute('theme', '{{ site.comments.utterances.theme }}');
            script.setAttribute('crossorigin', 'anonymous');
          {% endif %}

          commentsContainer.appendChild(script);
        }
      });
    };

    const observer = new IntersectionObserver(loadComments, { rootMargin: '0px 0px 200px 0px' });
    observer.observe(commentsSection);

    // Comments toggle logic
    const commentsToggle = document.getElementById('comments-toggle');
    const commentsContentWrapper = document.getElementById('comments-content-wrapper');
    const toggleIcon = commentsToggle ? commentsToggle.querySelector('.toggle-icon') : null;

    if (commentsToggle && commentsContentWrapper) {
      // Initialize as collapsed by default
      commentsContentWrapper.classList.add('collapsed');
      commentsToggle.classList.add('collapsed');
      if (toggleIcon) {
        toggleIcon.style.transform = 'rotate(-90deg)';
      }

      commentsToggle.addEventListener('click', () => {
        const isCollapsed = commentsContentWrapper.classList.toggle('collapsed');
        commentsToggle.classList.toggle('collapsed', isCollapsed);
        if (toggleIcon) {
          toggleIcon.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
        }
      });
    }
  });
</script>
{% endif %}
